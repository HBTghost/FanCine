"use strict";var countdownID,tickets=[{name:"Phổ thông",description:"Dành cho mọi đối tượng.",unitPrice:8e4},{name:"Học sinh/Sinh viên",description:"Chỉ dành cho học sinh và sinh viên.",unitPrice:75e3},{name:"VIP",description:"Chỉ dành cho thành viên VIP.",unitPrice:7e4}],combos=[{image:"https://www.galaxycine.vn/media/2020/5/19/combo-1_1589871759174.jpg",name:"Combo 1 Large",description:"1 Bắp + 1 Nước ngọt 32 Oz",unitPrice:72e3},{image:"https://www.galaxycine.vn/media/2020/5/19/combo-2_1589871763789.jpg",name:"Combo 2 Small",description:"1 Bắp + 2 Nước ngọt 22 Oz",unitPrice:81e3}],availableTicketsNumElement=document.getElementById("book-ticket-available-tickets-num"),ticketRowNumElements=document.querySelectorAll("#book-ticket-ticket-box .book-ticket-list .book-ticket-data-row .book-ticket-quantity"),ticketRowTotalPriceElements=document.querySelectorAll("#book-ticket-ticket-box .book-ticket-list .book-ticket-data-row .book-ticket-total-price-cell"),ticketTotalPriceElement=document.querySelector("#book-ticket-ticket-box .book-ticket-list .book-ticket-total-row .book-ticket-total-price-cell"),comboRowNumElements=document.querySelectorAll("#book-ticket-food-box .book-ticket-list .book-ticket-data-row .book-ticket-quantity"),comboRowTotalPriceElements=document.querySelectorAll("#book-ticket-food-box .book-ticket-list .book-ticket-data-row .book-ticket-total-price-cell"),comboTotalPriceElement=document.querySelector("#book-ticket-food-box .book-ticket-list .book-ticket-total-row .book-ticket-total-price-cell"),totalPriceElement=document.querySelector("#book-ticket-info-box .book-ticket-total-price span"),ticketDecBtnElements=document.querySelectorAll("#book-ticket-ticket-box .book-ticket-list .book-ticket-decrease-btn"),ticketIncBtnElements=document.querySelectorAll("#book-ticket-ticket-box .book-ticket-list .book-ticket-increase-btn"),comboDecBtnElements=document.querySelectorAll("#book-ticket-food-box .book-ticket-list .book-ticket-decrease-btn"),comboIncBtnElements=document.querySelectorAll("#book-ticket-food-box .book-ticket-list .book-ticket-increase-btn"),mandatorySeatsNumElement=document.querySelector("#book-ticket-mandatory-seats-num"),seatItemElements=document.querySelectorAll("#book-ticket-seat-room-sec .book-ticket-seat-auditorium .book-ticket-seat-area .book-ticket-seat-row .book-ticket-seat-item"),infoTicketElement=document.querySelector("#book-ticket-info-box .book-ticket-showtime-info-ticket"),infoComboElement=document.querySelector("#book-ticket-info-box .book-ticket-showtime-info-combo"),infoSeatElement=document.querySelector("#book-ticket-info-box .book-ticket-showtime-info-seat"),ticketfoodBoxElement=document.querySelector("#book-ticket-ticketfood-box"),seatBoxElement=document.querySelector("#book-ticket-seat-box"),checkoutBoxElement=document.querySelector("#book-ticket-checkout-box"),infoBackBtnElement=document.querySelector("#book-ticket-info-box .book-ticket-info-btn-row .book-ticket-info-back-btn"),infoContinueBtnElement=document.querySelector("#book-ticket-info-box .book-ticket-info-btn-row .book-ticket-info-continue-btn"),checkoutTimerElement=document.querySelector("#book-ticket-remaining-time-value"),checkoutBackBthElement=document.querySelector("#book-ticket-checkout-back-btn"),checkoutPayBthElement=document.querySelector("#book-ticket-checkout-pay-btn"),checkoutTotalPriceFieldElement=document.querySelector("#book-ticket-checkout-total-price"),myScreen=Object.freeze({TICKETFOOD:0,SEAT:1,CHECKOUT:2}),curScreen=myScreen.TICKETFOOD,ticketNames=tickets.map(function(e){return e.name}),comboNames=combos.map(function(e){return e.name}),ticketUnitPrices=tickets.map(function(e){return e.unitPrice}),comboUnitPrices=combos.map(function(e){return e.unitPrice}),ticketRowNums=Array(tickets.length).fill(0),ticketRowTotalPrices=Array(tickets.length).fill(0),ticketTotalPrice=0,comboRowNums=Array(combos.length).fill(0),comboRowTotalPrices=Array(combos.length).fill(0),comboTotalPrice=0,availableTicketsNum=availableTicketsNumElement.innerHTML,totalPrice=0,mandatorySeatsNum=0,selectedSeats=[],countdownMinutes=1,seatStateClassName=Object.freeze({SELECTED:"book-ticket-seat-selected",SOLD:"book-ticket-seat-sold",AVAILABLE:"book-ticket-seat-available"}),btnCursorClassName=Object.freeze({POINTER:"book-ticket-btn-pointer",DROP_ON:"book-ticket-btn-drop-on"});function formatPriceVND(e){return e.toLocaleString("it-IT",{style:"currency",currency:"VND"})}function init(){ticketRowNumElements.forEach(function(e){e.innerHTML=0}),ticketRowTotalPriceElements.forEach(function(e){e.innerHTML=formatPriceVND(0)}),ticketTotalPriceElement.innerHTML=formatPriceVND(0),comboRowNumElements.forEach(function(e){e.innerHTML=0}),comboRowTotalPriceElements.forEach(function(e){e.innerHTML=formatPriceVND(0)}),comboTotalPriceElement.innerHTML=formatPriceVND(0),totalPriceElement.innerHTML=formatPriceVND(0)}function getPrettierInfoStr(e){return e.slice(0,e.lastIndexOf(","))}function getTicketInfo(){for(var e="",t=0;t<ticketRowNums.length;++t)ticketRowNums[t]>0&&(e+="".concat(ticketNames[t]," (").concat(ticketRowNums[t],"), "));return getPrettierInfoStr(e)}function getComboInfo(){for(var e="",t=0;t<comboRowNums.length;++t)comboRowNums[t]>0&&(e+="".concat(comboNames[t]," (").concat(comboRowNums[t],"), "));return getPrettierInfoStr(e)}function getSeatInfo(){selectedSeats.sort();for(var e="",t=0;t<selectedSeats.length;++t)e+="".concat(selectedSeats[t],", ");return getPrettierInfoStr(e)}function getNameOfSeatItemElement(e){return e.firstElementChild.innerHTML+e.lastElementChild.innerHTML}function getPrettierTime(e){var t=parseInt(e/60,10).toString(),o=(e%60).toString();return 1===t.length&&(t="0".concat(t)),1===o.length&&(o="0".concat(o)),"".concat(t,":").concat(o)}function countdown(e){var t=60*e;checkoutTimerElement.innerHTML=getPrettierTime(t),countdownID=setInterval(function(){0===t?(clearInterval(countdownID),Swal.fire({title:"Oops...",icon:"error",html:"Giao dịch thất bại vì đã hết thời gian giao dịch cho phép (".concat(countdownMinutes," phút)!"),confirmButtonColor:"#3085d6",confirmButtonText:"Trở về trang chủ",showCancelButton:!0,cancelButtonColor:"#45B39D",cancelButtonText:"Đặt vé lại"}).then(function(e){e.isConfirmed?window.location="/":window.location="/showtimes"})):(t-=1,checkoutTimerElement.innerHTML=getPrettierTime(t))},1e3)}function main(){init()}ticketIncBtnElements.forEach(function(e,t){e.addEventListener("click",function(){availableTicketsNum>0&&(availableTicketsNum-=1,ticketRowNums[t]+=1,ticketRowTotalPrices[t]+=ticketUnitPrices[t],ticketTotalPrice+=ticketUnitPrices[t],totalPrice+=ticketUnitPrices[t],ticketRowNumElements[t].innerHTML=ticketRowNums[t],ticketRowTotalPriceElements[t].innerHTML=formatPriceVND(ticketRowTotalPrices[t]),ticketTotalPriceElement.innerHTML=formatPriceVND(ticketTotalPrice),totalPriceElement.innerHTML=formatPriceVND(totalPrice),availableTicketsNumElement.innerHTML=availableTicketsNum,infoTicketElement.innerHTML=getTicketInfo())})}),comboIncBtnElements.forEach(function(e,t){e.addEventListener("click",function(){comboRowNums[t]+=1,comboRowTotalPrices[t]+=comboUnitPrices[t],comboTotalPrice+=comboUnitPrices[t],totalPrice+=comboUnitPrices[t],comboRowNumElements[t].innerHTML=comboRowNums[t],comboRowTotalPriceElements[t].innerHTML=formatPriceVND(comboRowTotalPrices[t]),comboTotalPriceElement.innerHTML=formatPriceVND(comboTotalPrice),totalPriceElement.innerHTML=formatPriceVND(totalPrice),infoComboElement.innerHTML=getComboInfo()})}),ticketDecBtnElements.forEach(function(e,t){e.addEventListener("click",function(){ticketRowNums[t]>0&&(availableTicketsNum+=1,ticketRowNums[t]-=1,ticketRowTotalPrices[t]-=ticketUnitPrices[t],ticketTotalPrice-=ticketUnitPrices[t],totalPrice-=ticketUnitPrices[t],ticketRowNumElements[t].innerHTML=ticketRowNums[t],ticketRowTotalPriceElements[t].innerHTML=formatPriceVND(ticketRowTotalPrices[t]),ticketTotalPriceElement.innerHTML=formatPriceVND(ticketTotalPrice),totalPriceElement.innerHTML=formatPriceVND(totalPrice),availableTicketsNumElement.innerHTML=availableTicketsNum,infoTicketElement.innerHTML=getTicketInfo())})}),comboDecBtnElements.forEach(function(e,t){e.addEventListener("click",function(){comboRowNums[t]>0&&(comboRowNums[t]-=1,comboRowTotalPrices[t]-=comboUnitPrices[t],comboTotalPrice-=comboUnitPrices[t],totalPrice-=comboUnitPrices[t],comboRowNumElements[t].innerHTML=comboRowNums[t],comboRowTotalPriceElements[t].innerHTML=formatPriceVND(comboRowTotalPrices[t]),comboTotalPriceElement.innerHTML=formatPriceVND(comboTotalPrice),totalPriceElement.innerHTML=formatPriceVND(totalPrice),infoComboElement.innerHTML=getComboInfo())})}),seatItemElements.forEach(function(e){e.addEventListener("click",function(){e.classList.contains(seatStateClassName.AVAILABLE)?mandatorySeatsNum>0?(mandatorySeatsNum-=1,e.classList.remove(seatStateClassName.AVAILABLE),e.classList.add(seatStateClassName.SELECTED),mandatorySeatsNumElement.innerHTML=mandatorySeatsNum,selectedSeats.push(getNameOfSeatItemElement(e)),infoSeatElement.innerHTML=getSeatInfo()):Swal.fire({icon:"error",title:"Oops...",html:"<p>Đã hết số lượng vé!</p><p>Vui lòng quay lại để đặt thêm vé, hoặc tiếp tục để xác nhận thanh toán.</p>"}):e.classList.contains(seatStateClassName.SELECTED)&&(mandatorySeatsNum+=1,e.classList.add(seatStateClassName.AVAILABLE),e.classList.remove(seatStateClassName.SELECTED),mandatorySeatsNumElement.innerHTML=mandatorySeatsNum,selectedSeats.splice(selectedSeats.indexOf(getNameOfSeatItemElement(e)),1),infoSeatElement.innerHTML=getSeatInfo())})}),infoContinueBtnElement.addEventListener("click",function(){switch(curScreen){case myScreen.TICKETFOOD:(mandatorySeatsNum=ticketRowNums.reduce(function(e,t){return e+t},0))>0?(curScreen=myScreen.SEAT,ticketfoodBoxElement.style.display="none",seatBoxElement.style.display="block",infoBackBtnElement.style.display="block",mandatorySeatsNumElement.innerHTML=mandatorySeatsNum):Swal.fire({icon:"error",title:"Oops...",html:"Phải chọn số lượng vé để tiếp tục."});break;case myScreen.SEAT:0===mandatorySeatsNum?(countdown(countdownMinutes),curScreen=myScreen.CHECKOUT,seatBoxElement.style.display="none",checkoutBoxElement.style.display="block",infoBackBtnElement.style.display="none",infoContinueBtnElement.style.display="none",checkoutTotalPriceFieldElement.value=formatPriceVND(totalPrice)):Swal.fire({icon:"error",title:"Oops...",html:"<p>Phải chọn đủ số ghế đã đặt để tiếp tục.</p><p>Vui lòng chọn <b>thêm ".concat(mandatorySeatsNum," vị trí</b> nữa.</p>")});break;default:document.body.innerHTML="book-ticket.js - infoContinueBtnElement's click event"}}),infoBackBtnElement.addEventListener("click",function(){curScreen===myScreen.SEAT&&(curScreen=myScreen.TICKETFOOD,ticketfoodBoxElement.style.display="block",seatBoxElement.style.display="none",infoBackBtnElement.style.display="none",seatItemElements.forEach(function(e){e.classList.contains(seatStateClassName.SELECTED)&&(e.classList.remove(seatStateClassName.SELECTED),e.classList.add(seatStateClassName.AVAILABLE))}),selectedSeats=[],infoSeatElement.innerHTML="")}),checkoutBackBthElement.addEventListener("click",function(){clearInterval(countdownID),curScreen=myScreen.SEAT,checkoutBoxElement.style.display="none",seatBoxElement.style.display="block",infoBackBtnElement.style.display="block",infoContinueBtnElement.style.display="block"}),checkoutPayBthElement.addEventListener("click",function(){clearInterval(countdownID),fetch("/api/sessions/insertOne",{method:"POST",headers:{"Content-Type":"application/json; charset=UTF-8"},body:JSON.stringify({_idShowtime:window.location.href.slice(window.location.href.lastIndexOf("/")+1),ticketInfo:getTicketInfo(),comboInfo:getComboInfo(),seatInfo:getSeatInfo(),totalPrice:totalPrice,paymentMethod:document.querySelector("#book-ticket-checkout-payment-method").children[parseInt(document.querySelector("#book-ticket-checkout-payment-method").value,10)].innerHTML})}),Swal.fire({icon:"success",title:"Thành công",html:"Thanh toán thành công!"}).then(function(){forceLoginAndRedirect("/member/transaction-history")})}),main();